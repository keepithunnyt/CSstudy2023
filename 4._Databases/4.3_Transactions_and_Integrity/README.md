# 4.3 Transactions and Integrity

- [4.3.1 트랜잭션](#431-트랜잭션)
  - [원자성(Atomicity)](#원자성atomicity)
  - [일관성(Consistency)](#일관성consistency)
  - [격리성(Isolation)](#격리성isolation)
  - [지속성(Durability)](#지속성durability)
- [4.3.2 무결성](#432-무결성)

<br/>

---

# 4.3.1 트랜잭션
- 트랜잭션 : DB에서 하나의 논리 기능을 수행하기 위한 작업의 단위
  - 여러 개의 쿼리를 하나로 묶는 단위
  - ACID 특징을 가진다.

## 원자성(Atomicity)
- 트랜잭션과 관련된 일이 모두 수행되거나 되지 않음을 보장하는 특징
- 트랜잭션 단위로 여러 로직들을 묶을 때 외부 API를 호출하는 것이 있으면 안된다.
  - 롤백이 일어났을 때 어떻게 해야하는지 신경써야 하기 때문에

### 커밋과 롤백
- **커밋(commit)** - 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어
- **롤백(rollback)** : 트랜잭션으로 처리한 한 묶음을 과정이 일어나기 전으로 되돌리는 일

### 트랜잭션 전파
- 여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 함
  - 커넥션 단위로 수행하기 때문에, 커넥션 객체를 넘겨서 수행해야 하는데 이를 매번 넘겨주기 어렵고 귀찮기 때문
- Spring 프레임워크에서는 @Transactional 애너테이션을 통해 여러 쿼리 관련 코드들을 하나의 트랜잭션으로 처리한다.
```java
@Service
@Transactional(readOnly = true)
public class MemberService {
    private final MemberRepository memberRepository;

    public MemberService(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }
}
```
**애너테이션(annotation)**
  - Java 프로그래밍 언어에서 사용되는 메타데이터의 한 형태
  - 코드에 주석처럼 추가되며, 컴파일러나 런타임 환경에서 이용될 수 있는 정보를 제공하는 역할
  - 주로 클래스, 메서드, 필드 등의 선언에 부가 정보를 제공하거나 프로그램 요소에 대한 특별한 의미를 부여하기 위해 사용됨
  - @ 기호를 사용하여 선언되며, 클래스나 인터페이스를 통해 정의할 수 있음
  - 다른 코드 요소에 적용되기 위해 사용되며, 컴파일러는 애너테이션을 읽어 해당 요소에 대한 처리를 수행하거나 런타임 환경에서 애너테이션 정보를 활용한다.

## 일관성(Consistency)
 - 허용된 방식으로만 데이터를 변경해야 하는 것

## 격리성(Isolation)
- 트랜잭션 수행 시 서로 끼어들지 못하는 것을 의미
- 복수의 병렬 트랜잭션은 서로 순차적으로 실행되는 것처럼 작동되어야 하고, DB 여러 사용자가 같은 데이터에 접근할 수 있어야 한다.
- 격리수준 : SERIALIZABLE, REPEATABLE_READ, READ_COMMITED, READ_UNCOMMITED
  - 뒤로 갈수록 동시성이 강하고 격리성이 약함.
  - REPEATABLE_READ : 팬텀 리드 발생
  - READ_COMMITED : 팬텀 리드, 반복 가능하지 않은 조회 발생
  - READ_UNCOMMITED : 팬텀 리드, 반복 가능하지 않은 조회, 더티 리드 발생

#### 팬텀 리드(Phantom read)
- 한 트랜잭션 내에서 동일한 쿼리를 보냈는데 조회 결과가 다른 경우
- 조회 결과가 다른 행이 선택될 수 있다.

#### 반복 가능하지 않은 조회(non-repeatable read)
- 한 트랜잭션 내의 같은 행에 두 번 이상의 조회가 발생했는데 그 값이 다른 경우
- 행 값이 달라질 수 있다.

#### 더티 리드(Dirty Read)
-  한 트랜잭션이 실행중일 때, 다른 트랜잭션에 의해 수정되었지만 아직 커밋되지 않은 행의 데이터를 읽을 수 있을 때 발생

### 격리 수준
#### SERIALIZABLE
- 트랜잭션을 순차적으로 진행시킴. 여러 트랜잭션이 동시에 같은 행에 접근할 수 없음.

#### REPEATABLE_READ
- 하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막음.
- 하지만 새로운 행 추가는 막지 않는다.

#### READ_COMMITED
- 가장 많이 사용(MySQL8.0, PostgreSQL, SQL Server, Oracle 의 default)
- 트랜잭션이 커밋하지 않은 정보는 읽을 수 없다.
- 다른 트랜잭션이 접근한 행을 어던 트랜잭션이 수정할 수 있다.

#### READ_UNCOMMITED
- 가장 낮은 격리 수준
- 트랜잭션이 커밋되기 이전에 다른 트랜잭션에게 노출되는 문제 발생


## 지속성(Durability)
- 성공적으로 수행된 트랜잭션은 영원히 반영되어야 한다.
- 장애 복구를 위한 기능 필요 : 체크섬, 저널링, 롤백 등
  - 체크섬 : 중복 검사의 한 형태로 오류 정정을 통해 송신 데이터의 무결성 보호
  - 저널링 : 파일이나 DB 시스템에 변경사항을 반영하기 전에 로깅



<br/>

---


# 4.3.2 무결성
- 데이터의 정확성, 일관성, 유효성을 유지하는 것

|이름|설명|
|:---|:---|
|개체 무결성|기본키로 선택된 필드는 빈 값 불허|
|참조 무결성|서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야 함|
|고유 무결성|특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우, 그 속성 값은 모두 고유한 값이어야 함|
|NULL 무결성|특정 속성에 대해 NULL일 수 없다는 조건이 주어진 경우, 그 속성 값은 NULL이 될 수 없다.|